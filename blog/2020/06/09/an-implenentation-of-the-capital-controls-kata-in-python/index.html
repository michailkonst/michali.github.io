<!DOCTYPE html>
<html>

  <head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BXV6CVG7XQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BXV6CVG7XQ');
  </script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>An implementation of the Capital Controls kata in Python | Michali K</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="An implementation of the Capital Controls kata in Python" />
<meta name="author" content="Michali K" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A walkthrough of the Capital Controls Kata in Python. Train of thought and a retrospective." />
<meta property="og:description" content="A walkthrough of the Capital Controls Kata in Python. Train of thought and a retrospective." />
<link rel="canonical" href="http://www.michalikons.com/blog/2020/06/09/an-implenentation-of-the-capital-controls-kata-in-python/" />
<meta property="og:url" content="http://www.michalikons.com/blog/2020/06/09/an-implenentation-of-the-capital-controls-kata-in-python/" />
<meta property="og:site_name" content="Michali K" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-09T08:00:00+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="An implementation of the Capital Controls kata in Python" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Michali K"},"dateModified":"2020-06-09T08:00:00+10:00","datePublished":"2020-06-09T08:00:00+10:00","description":"A walkthrough of the Capital Controls Kata in Python. Train of thought and a retrospective.","headline":"An implementation of the Capital Controls kata in Python","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.michalikons.com/blog/2020/06/09/an-implenentation-of-the-capital-controls-kata-in-python/"},"url":"http://www.michalikons.com/blog/2020/06/09/an-implenentation-of-the-capital-controls-kata-in-python/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.michalikons.com/blog/2020/06/09/an-implenentation-of-the-capital-controls-kata-in-python/">
  <link rel="alternate" type="application/rss+xml" title="Michali K" href="http://www.michalikons.com/feed.xml" />
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
  <script>
  window.addEventListener("load", function(){
  window.cookieconsent.initialise({
    "palette": {
      "popup": {
        "background": "#237afc"
      },
      "button": {
        "background": "#fff",
        "text": "#237afc"
      }
    },
    "content": {
      "dismiss": "Okay"
    }
  })});
  </script>
  
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-2865828466412302",
        enable_page_level_ads: true
      });
    </script>
  
</head>


  <body>

    <header class="header">
  <div class="wrapper">
    <a class="site-title" href="/">Michali K</a>
    <nav class="site-nav">
      
        <a class="page-link" href="/blog/">Blog</a>
      
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    </nav>
  </div>
</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">An implementation of the Capital Controls kata in Python</h1>
    <p class="post-meta">Jun 9, 2020</p>
  </header>

  <article class="post-content">
    <p>In a previous article, I presented the <a href="/blog/2020/05/02/capital-controls-programming-kata/">Capital Controls Kata</a> and the intent to publish a walkthrough. Here it is.</p>

<h2 id="preparation">Preparation</h2>
<p>I used Visual Studio Code as my code editor and unittest as the Python test framework.</p>

<p>The entire code base is available on <a href="https://github.com/michali/CapitalControlsKata/">Github</a>.</p>

<h2 id="basic-functionality">Basic functionality</h2>
<p>Before we dive into imposing capital controls on our banks, we need to have a set of functioning bank operations! So, here is an anonymous bank that performs the following:</p>
<ul>
  <li>Cash deposits</li>
  <li>Cash withdrawals</li>
  <li>Domestic electronic transfers</li>
  <li>Electronic transfers abroad</li>
</ul>

<p>Each operation should result in a success or fail and that should be communicated to the caller.</p>

<p>The bank should disallow overdrafts, i.e. attempts to withdraw or transfer more money that is in the account should result to an insufficient funds message.</p>

<p>There would be a domain with a Bank and an Account class. Doing Test-Driven Development or Test-First Development doesn’t mean you don’t have an architecture in mind, you’re just not married to it.</p>

<p>Further, successful debits or credits would create a transaction object with a date and time. Unsuccessful attempts to debit or credit an account would not create a record of the operation, but only return an “operation failed” message to the caller. If there were a need to do include records of failed attempts to interact with an account as part of the basic functionality, we would revisit that as part of the restrictions imposition.</p>

<p>I made the operation of transfers abroad to act the same as a cash withdrawal - these operations have funds leave the domestic banking network and domestic banks lose track of those funds forever. Why have two different operations? At the time of coding the basic functionality I went really slowly and didn’t yet know how to differentiate the operations (this isn’t a real banking application where real money does get transferred out of a domestic bank and there is no database involved here either.)</p>

<h3 id="deposit-funds-to-an-account">Deposit funds to an account</h3>

<p>I started with the first test:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BankTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_deposit_to_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">BankAccount</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">balance</span><span class="p">)</span>
</code></pre></div></div>

<p>Pretty straightforward, there is a bank and there is an account.
 Defining the methods of the problem domain, I went on to implement the bank operation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bank</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">deposit_to_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">account</span><span class="p">.</span><span class="n">_deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> 
</code></pre></div></div>

<p>And the account:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span>
</code></pre></div></div>

<p>This was the third simplest thing that would make the test pass. Granted, you could have simply have the balance return a constant int of 100, triangulate with more test cases and arrive at the above code and that is, in fact, the approach I took in subsequent tests. An in-between approach would be to just assign the balance to the amount in the <code class="language-plaintext highlighter-rouge">_deposit</code> method. It’s easy to get carried away and jump to the solution if you know what to implement. The point here is to not get too far without tests preceding your implementation and I tried to make myself cognizant of that during the process.</p>

<h3 id="withdrawal">Withdrawal</h3>
<p>Withdrawal came next:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">balance</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code> class:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Account</code> class:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">amount</span>
</code></pre></div></div>

<p>I went slowly, but not that slowly. Instead of returning a constant from the <code class="language-plaintext highlighter-rouge">_withdraw</code> method, I subtracted the amount. Again, I could have taken it a step back and triangulated with more test cases.</p>

<p>Account methods <code class="language-plaintext highlighter-rouge">_deposit</code> and <code class="language-plaintext highlighter-rouge">_withdraw</code> are marked internal (with the leading underscore) as these should only be accessed from the same library.</p>

<p>One could argue that the <code class="language-plaintext highlighter-rouge">Bank</code> class may be starting to suffer from <a href="https://refactoring.guru/smells/feature-envy">feature envy</a>. At the moment it does nothing of its own but uses methods from the <code class="language-plaintext highlighter-rouge">Account</code> class. However, there is a strong argument to be made about class responsibilities and encapsulation - the user only interacts through their account via the bank, never directly through the account. The bank is, if you like, the gatekeeper between the ustomer and the account. If it turned out at the end of the implementation that the <code class="language-plaintext highlighter-rouge">Bank</code> class is redundant, the code would be refactored so <code class="language-plaintext highlighter-rouge">Bank</code> could be removed. You could also start from the bottom up and not have a <code class="language-plaintext highlighter-rouge">Bank</code> class in the first place until you need it. Remember, this is “Iteration 0” of the problem where we do not have a concept of future requirements where restrictions on capital could be asked of the development team.</p>

<p>Withdrawing an overdraft will result in a negative balance. Let’s fix that.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_withdraw_overdraft_doesnotallow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">balance</span><span class="p">)</span>
</code></pre></div></div>
<p>Passing the test:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">balance</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">amount</span>
</code></pre></div></div>

<p>Both withdrawal tests are passing.</p>

<p>At this point, it’s time to do some clean-up. Account.balance is a public and settable property. That is more than the current tests use. Also, it seems wrong that an external entity is able to manipulate something as important as an account’s balance on a whim.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="nb">property</span>
<span class="k">def</span> <span class="nf">Balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span>

<span class="k">def</span> <span class="nf">_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">+=</span> <span class="n">amount</span>

<span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>

</code></pre></div></div>

<p>We should also communicate the fact that a withdrawal operation (at first) may have failed due to insufficient funds. For that to happen, the <code class="language-plaintext highlighter-rouge">_withdraw</code> method can return an enum. I find this more intuitive than a boolean, even if we later on end up not expanding the scenarios for which a withdrawal may not happen.</p>

<p>Note that this time, in contrast with prevous examples, we are using parameterised tests to triangulate in order to arrive at the final algorithm in our production code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
<span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
<span class="p">(</span><span class="mi">400</span><span class="p">,),</span>
<span class="p">(</span><span class="mi">600</span><span class="p">,),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_withdraw_overdraft_results_in_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">Account</code> class:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<p>New enum in place.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OperationResult</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">Success</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">InsufficientFunds</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Bank</code> class doesn’t change.</p>

<p>So far, so good, but our basic functionality is very basic; there really needs to be a concept of a record that a transaction has taken place with every successful deposit, withdrawal and transfer.</p>

<h3 id="transaction">Transaction</h3>

<p>A transaction will have to be created with each deposit. That transaction should hold the date and time that it took place. The <code class="language-plaintext highlighter-rouge">Account</code> class should have a concept of transactions. Additionally, it seems wrong that an account can be initialised with a balance out of nowhere; every amount that is in the account should come in with a record of a transaction having taken place.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">300</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_deposit_to_account_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>

        <span class="n">operationResult</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">operationResult</span><span class="p">)</span>

        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_first_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_first_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Transaction</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Amount</span> <span class="o">=</span> <span class="n">amount</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">+=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">amount</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>

        <span class="p">.</span>
        <span class="p">.</span>
        <span class="p">.</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TransactionType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">Credit</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>Let’s add more properties to the transaction object apart from just its type. We will need an amount and the date and time it took place.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">300</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_deposit_to_account_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="o">@</span><span class="nb">classmethod</span>
            <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">daatetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">daatetimemock</span><span class="p">)</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
                
        <span class="n">operationResult</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">operationResult</span><span class="p">)</span>

        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_first_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
</code></pre></div></div>

<p>Expanding the previous test, we’re creating a mock that will give us a date and time we can assert to. We are also asserting an amount.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Transaction</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">DateTime</span> <span class="o">=</span> <span class="n">datetime</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span>

    <span class="k">def</span> <span class="nf">_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">+=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="p">.</span>
        <span class="p">.</span>
        <span class="p">.</span>
</code></pre></div></div>

<p>For withdrawals:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_withdraw_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="o">@</span><span class="nb">classmethod</span>
            <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>

        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
</code></pre></div></div>

<p>We want to assert there is a transaction for this withdrawal and it’s been marked as a debit</p>

<p>Account class:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<p>Transaction class:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TransactionType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">Credit</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">Debit</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div></div>
<p>Any potential for refactoring? Sure there is.</p>

<ul>
  <li>Passing the date/time onto a transaction shouldn’t be a responsibility of the Account class, in my opinion, but that of the Bank class. The Bank is the “driver” behind these operations, the account is a “receiver”. This is also shown by the way the tests are structured. We ever test the <code class="language-plaintext highlighter-rouge">Account</code> class directly, we test it through the <code class="language-plaintext highlighter-rouge">Bank</code> class, which is the interface between the user and their accounts.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Transactions</code> can (and should) be encapsulated into a private member with a getter.</li>
  <li>Same for the <code class="language-plaintext highlighter-rouge">Transaction</code> class’s members.</li>
</ul>

<p>Let’s begin.</p>

<h4 id="refactoring-1-moving-the-datetime-provider">Refactoring 1: Moving the date/time provider</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">300</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_deposit_to_account_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="o">@</span><span class="nb">classmethod</span>
            <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
                
        <span class="n">operationResult</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">operationResult</span><span class="p">)</span>

        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_first_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>

<span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_withdraw_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="o">@</span><span class="nb">classmethod</span>
            <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">class</span> <span class="nc">Bank</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetimeprovider</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span> <span class="o">=</span> <span class="n">datetimeprovider</span>

    <span class="k">def</span> <span class="nf">deposit_to_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span>
        
    <span class="k">def</span> <span class="nf">_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">+=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>

    <span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<h4 id="refactoring-2-transactions-in-account-made-private-with-a-getter">Refactoring 2: Transactions in Account made private with a getter</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">Transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span>

    <span class="k">def</span> <span class="nf">_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">+=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>

    <span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>

        <span class="p">.</span>
        <span class="p">.</span>
        <span class="p">.</span>
</code></pre></div></div>

<h4 id="refactoring-3-transaction-member-encapsulation">Refactoring 3: Transaction member encapsulation</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Transaction</span><span class="p">():</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">__type</span> <span class="o">=</span> <span class="nb">type</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">__amount</span> <span class="o">=</span> <span class="n">amount</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">__dateTime</span> <span class="o">=</span> <span class="n">datetime</span>
        <span class="o">@</span><span class="nb">property</span>
                <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__type</span>
        <span class="o">@</span><span class="nb">property</span>
                <span class="k">def</span> <span class="nf">Amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__amount</span>
        <span class="o">@</span><span class="nb">property</span>
                <span class="k">def</span> <span class="nf">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__dateTime</span>
</code></pre></div></div>

<h3 id="electronic-transfer-domestic">Electronic transfer (domestic)</h3>
<p>Next up is domestic electronic transfer of funds. The below test sets up balances on two accounts and then transfers funds from one to the other.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_eletronic_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account_from</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">account_to</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account_from</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account_to</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">account_from</span><span class="p">,</span> <span class="n">account_to</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">account_from</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">account_to</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>
<p><sub><sup>If you have to explain a unit test it’s probably a bad one.<sup>&lt;/sub&gt;</sup></sup></sub></p>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_from</span><span class="p">,</span> <span class="n">account_to</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">account_from</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">account_to</span><span class="p">.</span><span class="n">_deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>
<p><sup>In this implementation, if a <code class="language-plaintext highlighter-rouge">account_to._deposit(amount, date)</code> operation fails for whatsoever reason, the funds would be lost from the <code class="language-plaintext highlighter-rouge">account_from</code> account. For the purposes of this exercise, we will not be dealing with the transactionality of operations. <sup></sup></sup></p>

<p>It does pass the test but a transfer isn’t really a cash withdrawal and a deposit. We will have to rethink this functionality. But first, let’s implement the alectronic transfer abroad.</p>

<h3 id="eletronic-transfer-abroad">Eletronic transfer (abroad)</h3>
<p>We are starting with a test to update an account’s balance. We also want to keep the API of the <code class="language-plaintext highlighter-rouge">Bank</code> and the <code class="language-plaintext highlighter-rouge">Account</code> consistent with the other operations, so we are returning an <code class="language-plaintext highlighter-rouge">OperationResult</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_transfer_abroad_removes_from_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialbalance</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">initialbalance</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">initialbalance</span> <span class="o">-</span> <span class="n">withdrawalamount</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_transfer_abroad</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Account</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<p>Next up is to guard against an insufficient balance.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">400</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">600</span><span class="p">,),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test__transfer_abroad_insufficient_sender_funds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Account</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<p>And finally, the transaction:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test__transfer_abroad_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="o">@</span><span class="nb">classmethod</span>
            <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Account</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<h4 id="marking-debit-types">Marking debit types</h4>
<p>As mentioned earlier, for the purposes of this exercise we will only be simulating the difference between the various ways an account can be debited. In this instance we can mark debit as such.
We have three types of debit, one is for cash withdrawals, one for domestic bank transfers and one for transfers abroad. Let’s implement those.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_withdraw_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="o">@</span><span class="nb">classmethod</span>
            <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">DebitType</span><span class="p">.</span><span class="n">CashWithdrawal</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DebitType</span><span class="p">)</span>
</code></pre></div></div>

<p>The last line will assert that with a cash withdrawal, the transaction that is created will be marked as a Cash Withdrawal one.</p>

<p>In <code class="language-plaintext highlighter-rouge">Account</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">CashWithdrawal</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<p>And in <code class="language-plaintext highlighter-rouge">Transaction</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Transaction</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">debitType</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__dateTime</span> <span class="o">=</span> <span class="n">datetime</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__debitType</span> <span class="o">=</span> <span class="n">debitType</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__type</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">Amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__amount</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__dateTime</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">DebitType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__debitType</span>
</code></pre></div></div>

<p>New enum, <code class="language-plaintext highlighter-rouge">DebitType</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DebitType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CashWithdrawal</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>We follow the same logic to mark domestic transfers and transfers abroad. I did remove the cash withdrawal and deposit logic previously used to simulate a bank transfer and now I have a different operation in place that creates a transaction marked as a <code class="language-plaintext highlighter-rouge">DomesticElectronicTransfer</code>. I didn’t think that for this exercise we would need a way to distinguish between credit transactions so I didn’t implement one. The funds in a domestic electroncic transfer are still credited to the beneficiary with the generic <code class="language-plaintext highlighter-rouge">Account._deposit</code> method.</p>

<p>If a transaction is a debit transaction (it’s <code class="language-plaintext highlighter-rouge">TransactionType</code> property is <code class="language-plaintext highlighter-rouge">Debit</code>) then its <code class="language-plaintext highlighter-rouge">DebitType</code> property must not be <code class="language-plaintext highlighter-rouge">None</code>. This is not enforced by unit tests, this is an internal implementation of how <code class="language-plaintext highlighter-rouge">Account</code> creates transactions.</p>

<h2 id="restriction-1---ban-all-transfers-abroad-and-enforce-a-60-limit-on-daily-cash-withdrawals">Restriction 1 - ban all transfers abroad and enforce a $60 limit on daily cash withdrawals</h2>
<p>I must admit I only picked up steam once I reached that point. I thought this is going to be the real challenge of this exercise, how do we cleanly enforce restrictions in our bank operations?</p>

<p>As the business logic changes, the tests will change, so I started there. The assertions in place will only be valid if the withdrawal amount is $60 or less. Transfers abroad aren’t allowed.</p>

<h3 id="transfers-abroad">Transfers Abroad</h3>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_transfer_abroad_not_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
</code></pre></div></div>

<p>Simple as that. The account’s functionality remains untouched. The “guardian” to the account, which is the bank, controls what kind of access is given to an account.</p>

<p>Here I’ve introduced another named value in the <code class="language-plaintext highlighter-rouge">OperationResult</code> enum. <code class="language-plaintext highlighter-rouge">NotAllowed</code> means that although the funds are there to be debited from the account and the transfer can otherwise happen, there are restrictions in place that disallow this.</p>

<p>What’s happened to the other Transfer Abroad tests we had? The test that assert insufficient funds is now failing</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">200</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">400</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">600</span><span class="p">,),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test__transfer_abroad_insufficient_sender_funds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>Line <code class="language-plaintext highlighter-rouge">self.assertEqual(OperationResult.InsufficientFunds, result)</code> is now failing as the <code class="language-plaintext highlighter-rouge">OperationResult</code> we get back is <code class="language-plaintext highlighter-rouge">InsufficientFunds</code>. Also, this test case no longer applies as we simply disallow any and all transfers abroad. Therefore this and all other test that have driven the Transfer Abroad functionality except for the one we just added, no longer assert current business rules and are deleted.</p>

<h3 id="cash-withdrawals">Cash withdrawals</h3>

<p>New test with three test cases for triangulation:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">61</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">62</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">70</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_withdrawal_of_over_60_dollars_not_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>This obviously fails until we implement the desired functionality</p>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>

        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>

<p>Some test cases for <code class="language-plaintext highlighter-rouge">test_withdraw_removes_from_balance</code>,<code class="language-plaintext highlighter-rouge">test_withdraw_overdraft_results_in_error</code> and <code class="language-plaintext highlighter-rouge">test_withdraw_creates_transaction</code> are failing because thye are out of date so we update the test cases for the withdrawal amounts to conform to the new business rules.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_withdraw_removes_from_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialbalance</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">initialbalance</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">initialbalance</span> <span class="o">-</span> <span class="n">withdrawalamount</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>

<span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">20</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">40</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">60</span><span class="p">,),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_withdraw_overdraft_results_in_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawalamount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    
<span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">40</span><span class="p">,),</span>
        <span class="p">(</span><span class="mi">30</span><span class="p">,),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_withdraw_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">DateTimeMock</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="o">@</span><span class="nb">classmethod</span>
                <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">DateTimeMock</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
</code></pre></div></div>

<p>At this point I decided to swap the inner classes for mocking the date and time with Python’s <code class="language-plaintext highlighter-rouge">unittest.mock</code> library to make tests more readable.</p>

<h3 id="more-than-one-cash-withdrawal-in-a-day">More than one cash withdrawal in a day</h3>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">test_withdrawal_over_daily_amount_in_multiple_transactions_not_allowed_three_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>

        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">:</span>
                <span class="n">amount_already_drawn</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
            
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>
<p>Note the class variable <code class="language-plaintext highlighter-rouge">__max_daily_limit</code>. This is a constant set to 60. We have done away with the magic integer of 60 and have given it context.</p>

<p>This code will not renew the daily allowance of an account the next day. Let’s write a test that asserts that we will be able to.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_withdrawal_over_daily_amount_in_multiple_transactions_across_two_days_is_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>And in <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>

        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount_already_drawn</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
            
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>
<p>Here, we’re checking what has already been withdrawn on the day before we decide if the operation is allowed.</p>

<p>Removing the first two lines of <code class="language-plaintext highlighter-rouge">withdraw_from_account</code> does not affect the tests, therefore the lines were redundant.</p>

<h2 id="restriction-2-roll-over-missed-cash-withdrawals-for-up-to-a-week">Restriction 2: Roll over missed cash withdrawals for up to a week.</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">def</span> <span class="nf">test_withdrawal_if_monday_missed_withdraw_twice_as_much_on_tuesday</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="err">        </span>
<span class="err">        </span><span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
<span class="err">        </span><span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="err">        </span><span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
<span class="err">        </span><span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="err">        </span><span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="err">        </span><span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

<span class="err">        </span><span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="err">        </span><span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>Small steps here. May 12, 2020 is a Tuesday and we want to take out Tuesday’s allowance as well as Monday’s.</p>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>           
        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount_already_drawn</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

            <span class="k">if</span> <span class="n">money_drawn_previous_day</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
            
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>

<p>There’s a lot going on here. Is there any clean up we can do?</p>

<p>For one thing, some of the account querying can be moved where it’s better suited; the <code class="language-plaintext highlighter-rouge">Account</code> class.</p>

<p><code class="language-plaintext highlighter-rouge">Account</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>     
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>   
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">return</span> <span class="n">amount</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>           
        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

            <span class="k">if</span> <span class="n">money_drawn_previous_day</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>            
            
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>
<p>It’s already starting to look better. Proceeding further:</p>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>           
        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">money_drawn_previous_day</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>            
            
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>

<p>The account has now the additional responsibility of querying its transactions to return the amount that was withdrawn on a day and the bank makes a query when it needs it.</p>

<p>Only we can do better still. Whether or not to allow a withdrawal can move to its own method.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>       
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_withdraw</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>  
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>            
            
        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
 
            <span class="k">return</span> <span class="n">money_drawn_previous_day</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span>
        
        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>That will any missed allowance to carry over by a day. What about the rest of the week?</p>

<p>Let’s write a test to assert that on Saturday we will be able to withdraw any cash we didn’t withdrawn since Monday.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">def</span> <span class="nf">test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="err">        </span><span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
<span class="err">        </span><span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="err">        </span><span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
<span class="err">        </span><span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

<span class="err">        </span><span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="err">   </span><span class="c1"># Tuesday   
</span><span class="err">        </span><span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="err">        </span><span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="err">   </span><span class="c1"># Saturday   
</span><span class="err">        </span><span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>

<span class="err">        </span><span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="err">        </span><span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1690</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>Passing the test in <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">money_drawn_previous_day</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="mi">5</span>
        
        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>That will take us back five days to calculate withdrawn amounts. Philosophical analysis: this is <strong>any</strong> five days back, so if the current day was a Tuesday this implementation would calculate all withdrawn amounts back to Thursday next week so we’re getting more functionality than the unit test requires. This all comes down to “what is the smallest piece of code that will pass a test”. The above segment will pass the test. Placing guard clauses to only stop at the Monday of the current week (and not cover potential cases not covered by the newest unit test) would require additional code, so I didn’t do it as it seemed like I would overengineer the solution. However, there will be other unit tests that prevent the algorithm going back too far in the past.</p>

<p>After <code class="language-plaintext highlighter-rouge">test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</code>, passed, other tests failed. More specifically:</p>

<p><code class="language-plaintext highlighter-rouge">test_withdrawal_of_over_daily_limit_not_allowed</code>
<code class="language-plaintext highlighter-rouge">test_withdrawal_over_daily_limit_in_multiple_transactions_not_allowed_two_transactions</code>
<code class="language-plaintext highlighter-rouge">test_withdrawal_over_daily_limit_in_multiple_transactions_not_allowed_three_transactions</code></p>

<p>were failing as the implementaiton in <code class="language-plaintext highlighter-rouge">Bank</code> would go back five days in the past and wouldn’t stop on Monday. These tests won’t pass until we change the logic of the <code class="language-plaintext highlighter-rouge">Bank</code> class to stop on Monday of the current week and put new test cases on them.</p>

<p>Next up, we need to do something about this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">money_drawn_previous_day</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="n">money_drawn_previous_day</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>

<p>Sometimes you get to a point where writing a more generic algorithm may be simpler than passing this above case but you need to be careful how far away from your tests  you’re stepping. It seems like the time has come to implement the functionality to only go far back until the Monday for the current week.</p>

<p>Enriching a test in our test suite with test cases:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span> <span class="c1">#first day: Monday, second day:Saturday
</span>       <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span> <span class="c1">#first day: Tuesday, second day:Sunday
</span>       <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">361</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">),</span> <span class="c1">#first day: Thursday, second day:Sunday
</span>       <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">),</span> <span class="c1">#first day: Monday, second day:Tuesday
</span>    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_of_month_first_trn</span><span class="p">,</span> <span class="n">first_withdrawal_amount</span><span class="p">,</span> <span class="n">day_of_month_second_trn</span><span class="p">,</span> <span class="n">second_withdrawal_amount</span><span class="p">,</span> <span class="n">operation_result</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">day_of_month_first_trn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  
        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">first_withdrawal_amount</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">day_of_month_second_trn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">second_withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">operation_result</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">amount_already_drawn</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">amount_already_drawn</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span><span class="p">:</span> 
            <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
            <span class="n">money_withdrawn_this_week</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">money_withdrawn_this_week</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">i</span><span class="p">))</span>
          
            <span class="k">return</span> <span class="n">money_withdrawn_this_week</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>In Python, <code class="language-plaintext highlighter-rouge">datetime.weekday()</code> is a zero-based index of the day of the week, so it ranges from 0 (Monday) to 6 (Sunday). This passes the test but what can we do to make it better?</p>

<p>For one thing, removing line <code class="language-plaintext highlighter-rouge">amount_already_drawn = account._get_withdrawn_amount_on_date(now)</code> and the conditional <code class="language-plaintext highlighter-rouge">if amount_already_drawn + amount &gt; Bank.__max_daily_limit:</code> will still pass the test and can be removed. One could argue that without the if clause, the method will enumerate cash withdrawals for the past few days even if withdrawal eligibility is ruled out from day one, but our aim here is maintainability before performance. We can make it fast later if we have to. For now, let’s simplify our algorithm.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">money_withdrawn_this_week</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">money_withdrawn_this_week</span> <span class="o">+=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_on_date</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">money_withdrawn_this_week</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  
</code></pre></div></div>
<p>That’s good, except we can do better. Calculation of the money withdrawn in the current week can be moved to <code class="language-plaintext highlighter-rouge">Account</code> as it’s a query more appropriate for an account.</p>

<p><code class="language-plaintext highlighter-rouge">Bank</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span> 
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>     
        <span class="n">money_withdrawn_this_week</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">money_withdrawn_this_week</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>    
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Account</code> gets a new internal method:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">money_withdrawn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">money_withdrawn</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_withdrawn_amount_on_date</span><span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">money_withdrawn</span>
</code></pre></div></div>

<p>and a new private method:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>     
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>   
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>
        
        <span class="k">return</span> <span class="n">amount</span>
</code></pre></div></div>

<p>Test <code class="language-plaintext highlighter-rouge">test_withdrawal_if_monday_missed_withdraw_twice_as_much_on_tuesday</code> is now redundant and removed.</p>

<p>Test <code class="language-plaintext highlighter-rouge">test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</code> can have additional test cases to check what happens across weeks; if we attempt to draw out $121 on a Tuesday, that must be disallowed as up to $120 are permitted on any Tuesday.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">),</span> <span class="c1">#first day: Saturday, second day: Wednesday next week
</span>    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_withdrawal_if_less_than_the_limit_was_drawn_throughout_the_week_allow_withdrawal_up_to_today</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_of_month_first_trn</span><span class="p">,</span> <span class="n">first_withdrawal_amount</span><span class="p">,</span> <span class="n">day_of_month_second_trn</span><span class="p">,</span> <span class="n">second_withdrawal_amount</span><span class="p">,</span> <span class="n">operation_result</span><span class="p">):</span>
</code></pre></div></div>

<p>That passes without more production code, which means our previous implementation also covers that case.</p>

<p>Structure so far: account has methods to get money drawn out this day (private) and week (internal)</p>

<h2 id="restriction-3-trasfers-abroad-are-permitted-for-up-to-500">Restriction 3: Trasfers abroad are permitted for up to $500</h2>
<p>In this iteration we allow transfers abroad again but there is an upper limit.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">489</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">500.50</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">501</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">502</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">)</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_transfer_abroad_up_to_weekly_limit_500</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">operation_result</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">operation_result</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>which leads us to this implementation:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_transfer_abroad</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
</code></pre></div></div>

<p>with a bit of refactoring to give context to a “magic” number:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__max_weekly_bank_transfer_abroad_limit</span> <span class="o">=</span> <span class="mi">500</span>

<span class="k">def</span> <span class="nf">transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_weekly_bank_transfer_abroad_limit</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_transfer_abroad</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
</code></pre></div></div>

<h3 id="mark-electronic-transfers">Mark electronic transfers</h3>
<p>At this time there is no way of knowing whether a transaction is a transfer abroad one. We need to mark this. That could have been done as part of the basic functionality, but we can always apply it to new transactions going forward as it will be adequate to implement this new waiving of restrictions. We’re doing this for domestic transfers too.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DebitType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CashWithdrawal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ElectronicTransferDomestic</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">ElectronicTransferAbroad</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">50</span><span class="p">,),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test__transfer_abroad_creates_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DateTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferAbroad</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">DebitType</span><span class="p">)</span>
</code></pre></div></div>

<p>And in <code class="language-plaintext highlighter-rouge">Account</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_transfer_domestic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferDomestic</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>


<span class="k">def</span> <span class="nf">_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferAbroad</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<h3 id="multiple-electronic-transfers-abroad-to-reach-or-surpass-weekly-limit">Multiple electronic transfers abroad to reach or surpass weekly limit</h3>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span> 
       <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span> 
       <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_transfer_abroad_up_to_weekly_limit_two_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_withdrawal_amount</span><span class="p">,</span> <span class="n">second_withdrawal_amount</span><span class="p">,</span> <span class="n">second_trn_operation_result</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span>
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>     

        <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">first_withdrawal_amount</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">second_withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">second_trn_operation_result</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>
<p>A parameterised unit test like this will allow us to go past the initial implementation which would allow transfers abroad over the weekly limit if multiple of those were had.</p>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>  
            <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_transfer_abroad</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span> 

<span class="k">def</span> <span class="nf">__can_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span> 
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> 
        <span class="n">money_withdrawn_this_week</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">money_withdrawn_this_week</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_weekly_bank_transfer_abroad_limit</span>   
</code></pre></div></div>

<h3 id="testing-cash-withdrawals-first-and-transfers-abroad-second">Testing cash withdrawals (first) and transfers abroad (second)</h3>

<p>This is going to be interesting to see because in the <code class="language-plaintext highlighter-rouge">__can_transfer_abroad</code> method of the <code class="language-plaintext highlighter-rouge">Bank</code> class, before the decision whether to allow a transfer abroad is made, we’re checking the total amount that has been debited this week including cash withdrawals, not just transfers abroad. <code class="language-plaintext highlighter-rouge">Account._get_withdrawn_amount_this_week_so_far_for_date</code> will return a greater amount if also cash withdrawals were made during the week and legitimate below-limit amounts to be transferred abroad won’t check out. Let’s distinguish the two types of debit.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_withdraw_to_limit_and_transfer_abroad_to_limit_in_same_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>     
        <span class="n">result_withdraw</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
        <span class="n">result_transfer_abroad</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result_withdraw</span><span class="p">)</span>        
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result_transfer_abroad</span><span class="p">)</span>
</code></pre></div></div>
<p><sup>It was a bad idea to not mock the date here. I wrote this test on a Sunday. The next day this test failed when asserting that the cash withdrawal is successful. Why? (Hint: it’s in the business rules).</sup></p>

<p>In the <code class="language-plaintext highlighter-rouge">Bank</code> class:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span> 
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> 
        
        <span class="n">money_transfered_abroad_this_week</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_amount_transfered_abroad_this_week_so_far_for_date</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">money_transfered_abroad_this_week</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_weekly_bank_transfer_abroad_limit</span> 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code> is using the yet-unwritten <code class="language-plaintext highlighter-rouge">Account</code>’s method to get all the money that’s been transferred abroad this week.</p>

<p><code class="language-plaintext highlighter-rouge">Account</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_amount_transfered_abroad_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">money_withdrawn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">money_withdrawn</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_amount_transfered_abroad_for_date</span><span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">money_withdrawn</span>

<span class="k">def</span> <span class="nf">_get_amount_transfered_abroad_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>   
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
                <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DebitType</span> <span class="o">==</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferAbroad</span> \
                <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">return</span> <span class="n">amount</span>
</code></pre></div></div>

<h3 id="testing-transfers-abroad-second-and-cash-withdrawals-first">Testing transfers abroad (second) and cash withdrawals (first)</h3>

<p>Now, we’ll transfer money abroad and then withdraw cash. Bear in mind that <code class="language-plaintext highlighter-rouge">Account</code>’s <code class="language-plaintext highlighter-rouge">__get_withdrawn_amount_on_date</code> still looks like this:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>     
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>   
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>            
                <span class="n">amount</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">return</span> <span class="n">amount</span>
</code></pre></div></div>

<p>The amount for all debits on a given date will be returned.</p>

<p>Starting with a test:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_transfer_abroad_to_limit_and_withdraw_to_limit_and_in_same_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">()</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>    
        <span class="n">result_transfer_abroad</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> 
        <span class="n">result_withdraw</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result_transfer_abroad</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result_withdraw</span><span class="p">)</span>        
</code></pre></div></div>

<p>To pass this, we revisit <code class="language-plaintext highlighter-rouge">__get_withdrawn_amount_on_date</code> to add the cash withdrawal restriction</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__get_withdrawn_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>     
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>   
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>            
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">DebitType</span> <span class="o">==</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">CashWithdrawal</span> \
                <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">return</span> <span class="n">amount</span>
</code></pre></div></div>

<p>It’s time for some refactoring.</p>

<h3 id="refactor-1-factor-out-debit-transaction-queries">Refactor 1: Factor out debit transaction queries</h3>

<p>There are two private methods in <code class="language-plaintext highlighter-rouge">Account</code> that largely do the same thing; one gets the total amount withdrawn as cash on a date and the other gets the total amount transfered abroad. We can extract a common method for the two.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_debited_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">CashWithdrawal</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_amount_transfered_abroad_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_debited_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferAbroad</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__get_debited_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">debit_type</span><span class="p">):</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">money_withdrawn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">money_withdrawn</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_debited_amount_on_date</span><span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">i</span><span class="p">),</span> <span class="n">debit_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">money_withdrawn</span>    

<span class="k">def</span> <span class="nf">__get_debited_amount_on_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">debit_type</span><span class="p">):</span>     
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>   
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
                <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DebitType</span> <span class="o">==</span> <span class="n">debit_type</span> \
                <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">amount</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>

        <span class="k">return</span> <span class="n">amount</span>
</code></pre></div></div>

<p>No tests are failing.</p>

<h3 id="refactor-2-factor-out-debit-transaction-operations">Refactor 2: Factor out debit transaction operations</h3>

<p>Withdrawing and transfering are very similar in our example. All that is changing is the marking of a transaction with a <code class="language-plaintext highlighter-rouge">DebitType</code> enum value.</p>

<p><code class="language-plaintext highlighter-rouge">Account</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__debit</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">CashWithdrawal</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_transfer_domestic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__debit</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferDomestic</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__debit</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">DebitType</span><span class="p">.</span><span class="n">ElectronicTransferAbroad</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__debit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">debit_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">InsufficientFunds</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">__balance</span> <span class="o">-=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__transactions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Transaction</span><span class="p">(</span><span class="n">TransactionType</span><span class="p">.</span><span class="n">Debit</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">debit_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span>
</code></pre></div></div>

<p>Tests are passing</p>

<h2 id="restriction-4-new-deposits-are-exempt-from-withdrawal-restrictions">Restriction 4: New deposits are exempt from withdrawal restrictions</h2>

<p>Here we can either mark new deposits as “fresh” or query the account with every attempt to withdrawal/transfer to check if enough funds were deposited after a certain “restrictions ease” date to qualify. Both methods have the pros and cons. The first option is good for performance at withdrawals. The second option keeps the theoretical backend database (or several databases) free of changes. Given that capital controls are (hopefully) temporary, we don’t want to be in a situation where we’re changing a database (or several) and then reverting and retesting once the restrictions are over, so we’re going with option 2.</p>

<p>Let’s start with our test. The date we are selecting for this capital control relaxation is Monday 18/05/2020.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_new_deposits_are_exempt_from_withdrawal_restrictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>      
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">## Monday
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">result_withdraw</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result_withdraw</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>Implementation in <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>                
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_withdraw</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">__is_fresh_deposit</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>  
                <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>            

        <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">__is_fresh_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">account</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span> <span class="o">==</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>        

        <span class="k">return</span> <span class="n">amount</span> <span class="o">==</span> <span class="n">total_deposits_after_cutoff_date</span>
</code></pre></div></div>

<p>This passes the test. Let’s refactor. The query in <code class="language-plaintext highlighter-rouge">__is_fresh_deposit</code> can be move to <code class="language-plaintext highlighter-rouge">Account</code> in the same fashion as previous queries.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">_get_total_amount_for_credits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>        

        <span class="k">return</span> <span class="n">total_deposits_after_cutoff_date</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code> becomes:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__is_fresh_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">==</span> <span class="n">total_deposits_after_cutoff_date</span>
</code></pre></div></div>

<p>The relaxation date stays with the bank, the rule-setter.</p>

<p>We should also do away with the “magic” date in <code class="language-plaintext highlighter-rouge">__is_fresh_deposit</code> and move it to a class variable.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__start_date_for_fresh_transactions</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__is_fresh_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits</span><span class="p">(</span><span class="n">__start_date_for_fresh_transactions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">==</span> <span class="n">total_deposits_after_cutoff_date</span>
</code></pre></div></div>

<p>We should also be able to “dig” into our previous savings that had been there before 18/05/2020 after exhausting any funds deposited to the account after that date.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span> <span class="c1"># Monday, Day restrictions are eased for new deposits
</span>        <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">321</span><span class="p">,</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">)</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_can_withdraw_daily_amount_with_rollover_plus_deposits_after_20200518</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_of_month_to_withdraw</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">withdrawal_result</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>      
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Day before restrictions are eased for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">day_of_month_to_withdraw</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">withdrawal_result</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">withdrawal_result</span><span class="o">==</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">320</span> <span class="o">-</span> <span class="n">withdrawal_amount</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span> <span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">withdraw_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>       
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_withdraw</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_withdraw_with_fresh_deposit</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>  
            <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>   

<span class="k">def</span> <span class="nf">__can_withdraw_with_fresh_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits_on_and_after_date</span><span class="p">(</span><span class="n">Bank</span><span class="p">.</span><span class="n">__start_date_for_fresh_transactions</span><span class="p">)</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">weekday</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Account</code>, <code class="language-plaintext highlighter-rouge">_get_total_amount_for_credits</code> is renamed and modified.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_total_amount_for_credits_on_and_after_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">Transactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trn</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TransactionType</span><span class="p">.</span><span class="n">Credit</span> <span class="ow">and</span> <span class="n">trn</span><span class="p">.</span><span class="n">DateTime</span><span class="p">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+=</span> <span class="n">trn</span><span class="p">.</span><span class="n">Amount</span>        

        <span class="k">return</span> <span class="n">total_deposits_after_cutoff_date</span>
</code></pre></div></div>

<p>Let’s assert that transfers abroad behave the same, with their own weekly $500 limit.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_can_transfer_abroad_above_weekly_limit_with_deposits_after_20200518</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>      
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Day before restrictions are eased for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">__can_transfer_abroad_with_fresh_deposit</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>  
            <span class="k">return</span> <span class="n">account</span><span class="p">.</span><span class="n">_transfer_abroad</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span>
</code></pre></div></div>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_transfer_abroad_with_fresh_deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits_on_and_after_date</span><span class="p">(</span><span class="n">Bank</span><span class="p">.</span><span class="n">__start_date_for_fresh_transactions</span><span class="p">)</span>

        <span class="n">money_transfered_abroad_this_week</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_amount_transfered_abroad_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">amount</span> <span class="o">==</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_weekly_bank_transfer_abroad_limit</span> <span class="o">+</span> <span class="n">total_deposits_after_cutoff_date</span> <span class="o">-</span> <span class="n">money_transfered_abroad_this_week</span>
</code></pre></div></div>

<h3 id="cleanup">Cleanup</h3>
<p>The OR conditional in the <code class="language-plaintext highlighter-rouge">transfer_abroad</code> method is in place in order to make sure existing, up-to-date tests aren’t broken when adding new rules. However, the bodies of <code class="language-plaintext highlighter-rouge">__can_transfer_abroad</code> and <code class="language-plaintext highlighter-rouge">__can_transfer_abroad_with_fresh_deposit</code> look a lot alike and it turns out that <code class="language-plaintext highlighter-rouge">__can_transfer_abroad</code> is a redundant check that can be removed without failing the tests. <code class="language-plaintext highlighter-rouge">__can_transfer_abroad_with_fresh_deposit</code> covers both “fresh” deposits as well as older ones. The same is true of the <code class="language-plaintext highlighter-rouge">withdraw_from_account</code>, so the extra check there is removed.</p>

<h3 id="asserting-interwowen-cash-withdrawals-and-transfer-abroad-transactions">Asserting interwowen cash withdrawals and transfer abroad transactions</h3>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_can_withdraw_and_transfer_abroad_daily_amount_with_rollover_plus_deposits_after_20200518</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>  
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Day before restrictions are eased for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>        
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">1920</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_can_withdraw_and_transfer_abroad_daily_amount_with_rollover_plus_deposits_after_20200518_over_limit_not_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>  
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Day before restrictions are eased for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>       
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">transfer_abroad</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">1400</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2800</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>
<p>Before the first deposit, we always set the date to a date earlier than 18/05/2020 so the money debited are subject to restrictions</p>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits_on_and_after_date</span><span class="p">(</span><span class="n">Bank</span><span class="p">.</span><span class="n">__start_date_for_fresh_transactions</span><span class="p">)</span>
        <span class="n">money_withdrawn_this_week_so_far_for_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="n">money_withdrawn_this_week_so_far_for_date</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Account</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_debited_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">debit_type</span><span class="p">):</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">money_debited</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">money_debited</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__get_debited_amount_on_date</span><span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">i</span><span class="p">),</span> <span class="n">debit_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">money_debited</span>
</code></pre></div></div>

<p>And with yet another method extraction in <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__can_withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits_on_and_after_date</span><span class="p">(</span><span class="n">Bank</span><span class="p">.</span><span class="n">__start_date_for_fresh_transactions</span><span class="p">)</span>
        <span class="n">money_withdrawn_this_week_so_far_for_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_withdrawn_amount_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">__calculate_max_withdrawal_limit_on_current_day_of_week</span><span class="p">()</span> <span class="o">-</span> <span class="n">money_withdrawn_this_week_so_far_for_date</span>
    
<span class="k">def</span> <span class="nf">__calculate_max_withdrawal_limit_on_current_day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">weekday</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__can_transfer_abroad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">total_deposits_after_cutoff_date</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_total_amount_for_credits_on_and_after_date</span><span class="p">(</span><span class="n">Bank</span><span class="p">.</span><span class="n">__start_date_for_fresh_transactions</span><span class="p">)</span>
        <span class="n">money_transfered_abroad_this_week</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">_get_amount_transfered_abroad_this_week_so_far_for_date</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">total_deposits_after_cutoff_date</span> <span class="o">+</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_weekly_bank_transfer_abroad_limit</span> <span class="o">-</span> <span class="n">money_transfered_abroad_this_week</span>
</code></pre></div></div>

<h2 id="restriction-5-extend-time-limit-to-two-weeks">Restriction 5: extend time limit to two weeks</h2>

<p>We’ll start with cash withdrawals. As each week starts on Monday, we’ll set a Monday to act as the starting day the two weeks will start from, and will be renewed two Mondays later.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_missed_daily_cash_withdrawals_can_be_backed_up_for_two_weeks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>  
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># This is a date before restrictions are eased (18-5-2020) for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">840</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">Success</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1160</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">Balance</span><span class="p">)</span>
</code></pre></div></div>

<p>Again, we deposit some money before the date Iteration 4 takes effect so they are subject to the capital control restrictions as the rules don’t apply to any money deposited afterwards. Then, at a date in the future, we withdraw $840. We pick 1-Jun-2020 as the date Iteraion 5 takes effect.</p>

<p>In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__calculate_max_withdrawal_limit_on_current_day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="n">now</span> <span class="o">=</span>  <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">date</span><span class="p">()):</span>
            <span class="n">day_of_week_index2</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">date</span><span class="p">()).</span><span class="n">days</span>
            <span class="k">return</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">day_of_week_index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">weekday</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">day_of_week_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>A bit crude, for now, but the test has become green. Expectedly, some tests have failed after changing the above method. These pertain to cash withdrawals (as this is what we’ve just changed now) and the maximum withdrawal amount that spanned across a week but it now spans across two.</p>

<p>Our next step is to assert that additional funds cannot be withdrawn until the two-week period has elapsed.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
        <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_missed_daily_cash_withdrawals_over_two_weeks_old_does_not_roll_over_for_old_deposits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>  
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># This is a date before restrictions are eased (18-5-2020) for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 20 days after 1-6-2020, when missed cash allowance started rolling over in the space of two weeks
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>That’s failing, so we’re adding this to <code class="language-plaintext highlighter-rouge">Bank</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">__calculate_max_withdrawal_limit_on_current_day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="n">now</span> <span class="o">=</span>  <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">()</span>

        <span class="n">day_of_week_index_two_weeks</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">date</span><span class="p">()).</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">day_of_week_index_two_weeks</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">:</span>
            <span class="n">day_of_week_index_two_weeks</span> <span class="o">=</span> <span class="n">day_of_week_index_two_weeks</span> <span class="o">-</span> <span class="mi">14</span>

        <span class="k">return</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="n">day_of_week_index_two_weeks</span>
</code></pre></div></div>

<p>This will make test cases for <code class="language-plaintext highlighter-rouge">test_missed_daily_cash_withdrawals_over_two_weeks_old_does_not_roll_over_for_old_deposits</code> pass provided these do not exceed 28 days after 1/6/2020. So, let’s add test cases for July and fail them!</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">parameterized</span><span class="p">.</span><span class="n">expand</span><span class="p">([</span>
       <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
       <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">241</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_missed_daily_cash_withdrawals_over_two_weeks_old_does_not_roll_over_for_old_deposits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">):</span>
        <span class="n">datetimemock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>        
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">()</span> 
        <span class="n">bank</span> <span class="o">=</span> <span class="n">Bank</span><span class="p">(</span><span class="n">datetimemock</span><span class="p">)</span>  
        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># This is a date before restrictions are eased (18-5-2020) for new deposits
</span>        <span class="n">bank</span><span class="p">.</span><span class="n">deposit_to_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="n">datetimemock</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 20 days after 1-6-2020, when missed cash allowance started rolling over in the space of two weeks
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">bank</span><span class="p">.</span><span class="n">withdraw_from_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">OperationResult</span><span class="p">.</span><span class="n">NotAllowed</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>You see where this is going. We need to think in terms of 14-day intervals.</p>

<p><code class="language-plaintext highlighter-rouge">Bank</code></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__calculate_max_withdrawal_limit_on_current_day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="n">now</span> <span class="o">=</span>  <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">()</span>

        <span class="n">day_of_week_index_two_weeks</span> <span class="o">=</span> <span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">date</span><span class="p">()).</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">14</span>

        <span class="k">if</span> <span class="n">day_of_week_index_two_weeks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">day_of_week_index_two_weeks</span> <span class="o">=</span> <span class="mi">14</span>

        <span class="k">return</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="n">day_of_week_index_two_weeks</span>
</code></pre></div></div>

<p>A little refactoring is in order. In <code class="language-plaintext highlighter-rouge">Bank</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">__start_of_two_week_periods</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">date</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">__calculate_max_withdrawal_limit_on_current_day_of_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="n">now</span> <span class="o">=</span>  <span class="bp">self</span><span class="p">.</span><span class="n">__datetimeprovider</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">date</span><span class="p">()</span>

        <span class="n">day_of_week_index_two_weeks</span> <span class="o">=</span> <span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__start_of_two_week_periods</span><span class="p">).</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">14</span>
        <span class="n">day_of_week_index_two_weeks</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__adjust_for_end_of_two_week_period</span><span class="p">(</span><span class="n">day_of_week_index_two_weeks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Bank</span><span class="p">.</span><span class="n">__max_daily_limit</span> <span class="o">*</span> <span class="n">day_of_week_index_two_weeks</span>

<span class="k">def</span> <span class="nf">__adjust_for_end_of_two_week_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_of_week_index_two_weeks</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">14</span> <span class="k">if</span> <span class="n">day_of_week_index_two_weeks</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">day_of_week_index_two_weeks</span>
</code></pre></div></div>

<p>There are more tests failing still. That is happening because restrictions are now reset every other week instead of every week and the withdrawal amount has proportionately increased. We need to go through all the failing tests one-by-one and adjust them. I started with the smaller ones, such as <code class="language-plaintext highlighter-rouge">test_withdraw_creates_transaction</code> and proceeded to the longer ones. Tests are updated with new dates post 1-6-2020 as the release will happen after a specific date and the rules will be referencing that specific date. Edge cases which previously failed are also updated with appropriate dates and amounts. We’re not losing generality, just like we didn’t lose generality implementing Iteration 4 as the releases would take place on the dates that are referenced in <code class="language-plaintext highlighter-rouge">Bank</code> as class variables.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>As mentioned I didn’t initially have a mock to generate dates at will, because <a href="https://martinfowler.com/bliki/Yagni.html">YAGNI</a>, yet I didn’t want to reference a <code class="language-plaintext highlighter-rouge">datetime</code> straight from the <code class="language-plaintext highlighter-rouge">Bank</code> class but wanted to have it as a constructor dependency in order for the <code class="language-plaintext highlighter-rouge">Bank</code> class to advertise the fact that it needs a <code class="language-plaintext highlighter-rouge">datetime</code> object.</p>

<p>As I was changing the implementation code, existing tests acted as a safeguard that ensured that unrelated functionality didn’t break. This is one of the benefits of having unit tests and a good coverage apart from all the other benefits, such as not overengineering your implementation and reducing regressions.</p>

<p>If requirements changed in a future iteration, there was a time I would go back to existing unit tests and change the assertions and/or parameters that went into the “Act” phase of the test, then pass that change test in the production code. That would work for me if the unit tests were fewer than they are in this instance. If there are heaps of unit tests, these days I write a new test, pass it and, in case any old tests are broken, understand why and fix them (or fix the production code, or both). It could be that they are failing because they’ve become outdated with the changing of the requirements and some may even need to be removed. Any such possibilities are spotted at once once you’ve implemented a change and tests start to fail.</p>

<p>One way to manage releases which are date-dependant as Iterations 4 and 5 in this exercise is to release ahead of time instead of the midnight of the day past the deadline and have two branches of logic depending on what date it is. This implementation assumes that production systems are shut down for maintenance on the midnight past the deadline and the new code is deployed during that window. It’s all about what approach you;d like to take.</p>

  </article>
  
  

<div class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'michalikons'; // required: replace example with your forum shortname
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</div>



</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="/assets/profile.jpg" alt="Michali K">
  <div class="col-box-title name">Michali K</div>
  <p>Software Developer</p>
  <p class="contact">
    
    <a href="https://github.com/michali">GitHub</a>
    
    
    
    <a href="mailto:michali@michalikons.com">Email</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/blog/2024/08/24/automate-all-the-things-a-manifesto-for-building-better-teams/">Automate All The Things: A Manifesto for Building Better Teams</a></li>
    
      <li><a class="post-link" href="/blog/2023/11/02/moving-files-between-git-repositories-history/">Preserve commit history when moving files across Git repositories</a></li>
    
      <li><a class="post-link" href="/blog/2023/10/07/publisling-jekyll-site-to-a-separate-github-pages/">Publishing a Jekyll site to a separate Github Pages repository using Github Actions</a></li>
    
      <li><a class="post-link" href="/blog/2023/09/19/writing-a-novel-with-visual-studio-code/">Writing a Novel with Visual Studio Code</a></li>
    
      <li><a class="post-link" href="/blog/2022/10/01/newrelic-agent-apline-docker-container/">Installing the NewRelic .NET agent on an Alpine Docker image</a></li>
    
  </ul>
</div>

<div class="col-box">
  <div class="col-box-title"><a href="/blog/archive/">Archive</a></div>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>
        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2024 Michali K - Powered by <a href="https://jekyllrb.com"/>Jekyll</a> - <a href="/privacy-policy"/>Privacy Policy</a> - <a href="https://github.com/laobubu/jekyll-theme-EasyBook/">EasyBook theme by @laobubu</a>
</div>
</footer>

<script src="/js/easybook.js"></script>

  </body>

</html>
